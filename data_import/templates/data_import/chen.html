{% extends "data_import/base.html" %}
{% block title %}{% if title %}{{ title }}{% endif %}{% endblock %}
{% block content %}

<h2>青钢转炉数据分析</h2>
<h5><a href='/fluctuation'>波动率相关分析</a></h5>

<div>
    <p><strong>1.钢种、班次、班别、工位筛选条件下的字段统计情况：</strong></p>
    钢种：<select name="gk_no1" id="gk_no1" class="gangzhong_name"></select>
    班次：<select name="OPERATESHIFT" id="OPERATESHIFT" class="OPERATESHIFT_name">
        <option value='blank' selected = "selected"></option>
        <option value=1>白班</option>
        <option value=2>中班</option>
        <option value=3>夜班</option>
    </select>
    班别：<select name="OPERATECREW" id="OPERATECREW" class="OPERATECREW_name">
        <option value='blank' selected = "selected"></option>
        <option value='A'>甲班</option>
        <option value='B'>乙班</option>
        <option value='C'>丙班</option>
    </select>
    工位：<select name="station" id="station" class="station_name">
        <option value='blank' selected = "selected"></option>
        <option value='BOF1'>BOF1</option>
        <option value='BOF2'>BOF2</option>
        <option value='BOF3'>BOF3</option>
    </select>
    字段名<select name="bookno2" id="bookno2" class="procedurename1"></select>
    <button onclick='multi_analy()' id='multi_analy'>综合统计分析</button>
</div>
    <p>注：当四个筛选条件同时生效时，满足的数据量很少，甚至无该条件下的数据。</p>
-------------------------------------------------------------------------------
<div>
    <p><strong>2.单炉次投入成本及产品产出统计情况 and 3.单炉次因素偏高偏低展示</strong></p>
    <p>请输入要选择的炉次号，例如：1634230</p>
    炉次号：<input type="text" name="prime_analyse" value="{{current_tableno}}" id="prime_analyse">
    <button onclick='cost()' id='click2'>投入成本分析结果</button>
    <button onclick='produce()' id='click3'>产出产品分析结果</button>
</div>

<div style="width:1600px">
<div id="main1" style="float:left;width:800px;height:500px">左</div>
<div id="main2" style="float:left;width:800px;height:500px">右</div>
<!--<textarea id="txt" style="width: 800px;height:100px;">下</textarea></div>-->
</div>
<!--
<span id='wrong-message' style="color:red"></span>
<span id='hover-console' style="color:#1e90ff"></span>
<span id='console' style="color:#1e90ff">Event Console</span>
-->
<script type="text/javascript" src="/static/data_import/js/loadChart_chen.js"></script>
<script type="text/javascript" src="/static/data_import/js/loadParam.js"></script>
<script type="text/javascript"> 
    //多条件综合筛选
    function multi_analy(){
        var bookno = $("#bookno2").val();//字段，需要转化为大写
        var gk_no = $("#gk_no1").val();//钢种,不用转化为大写
        var OPERATESHIFT = $("#OPERATESHIFT").val();//班次
        var OPERATECREW = $("#OPERATECREW").val();//班别
        var station = $("#station").val();//工位
        alert("gk_no:"+gk_no+"\nOPERATESHIFT:"+OPERATESHIFT+"\nOPERATECREW:"+OPERATECREW+"\nstation:"+station+"\nbookno:"+bookno);
        $.ajax({
            type: "post",
            url:  "/multi_analy",
            data: {'bookno':bookno,'gk_no':gk_no,'OPERATESHIFT':OPERATESHIFT,'OPERATECREW':OPERATECREW,'station':station},
            error: function() {
                alert("发生错误，可能是无该筛选条件下的数据！");
            },
            success: function(data) {
                //alert("multi_analy");
                alert(data.state);
                //alert(data.result);
                //alert(data.result.xname)
                //alert(data.result.yvalue)
                drawBarChart2(data.result)
            }
         })
    }

    //成本消耗
    function cost(){
        var prime_analyse = $("#prime_analyse").val();
        console.log(prime_analyse)
        $.ajax({
            type: "post",
            url:  "/cost",
            data: {'prime_cost':prime_analyse},
            error: function() {
                alert("错误！！");
            },
            success: function(data) {
                //alert(data.result);
                //alert(data.result.xname)
                //alert(data.result.yvalue)
                drawBarChart_test(data.result);
            }
        })
    };   
    //产品产出
    function produce(){
         var prime_analyse = $("#prime_analyse").val();
        console.log(prime_analyse)
        $.ajax({
            type: "post",
            url:  "/produce",
            data: {'prime_produce':prime_analyse},
            error: function() {
                alert("错误！！");
            },
            success: function(data) {
                //alert(data.result)
                //alert(data.result.xname)
                //alert(data.result.yvalue)
                drawBarChart_test(data.result)
            }
        })
    };  

    // 条形图（投入和产出）与loadChart_chen.js中的drawBarChart相同
    //xasis_fieldname
    function drawBarChart_test(result){
        var myChart = echarts.init(document.getElementById('main1'));
            // 指定图表的配置项和数据
            var option = {
                title: {
                    text: '炉次号'+result.heat_no+'的'+result.attribute+'组成',
                    x:'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                        type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                     }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    data: result.xname,
                    axisLabel :{  
                            interval:0,//横轴信息全部显示
                            //rotate: 60//60度角倾斜显示  
                        } 
                },
                yAxis: {
                    name:'Kg'
                },
                series: [{
                    name: '投入量(Kg)',
                    type: 'bar',
                    data: result.yvalue,
                    markPoint: {
                        data:[
                                //{type : 'max', name: '最大值'},
                                //{type : 'min', name: '最小值'}
                                //{name : '标记点测试', value : 100, xAxis: result.scope[1], yAxis: 0.2}  
                        ]
                    },
                    itemStyle: {
                        normal: {
                            //color: 'tomato',
                            //barBorderColor: 'tomato',
                            barBorderWidth: 6,
                            barBorderRadius:0,
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }

                }
                ]
            };
    //--------------------------------------------------
       var ecConfig = echarts.config;  
        function eConsole(param) {
            //var mes = '【' + param.type + '】';
            if (typeof param.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                fieldname_chinese=param.name;
                fieldname_english=result.xEnglishname[param.dataIndex];
                ch_num2(fieldname_chinese,fieldname_english);
            }
            // if (param.type == 'hover') {
            //     document.getElementById('hover-console').innerHTML = 'Event Console : ' + mes;
            // }
            // else {
            //     document.getElementById('console').innerHTML = mes;
            // }
            console.log(param);
        }

        myChart.on(ecConfig.EVENT.CLICK, eConsole);
        myChart.on(ecConfig.EVENT.DBLCLICK, eConsole);
        //myChart.on(ecConfig.EVENT.HOVER, eConsole);
        myChart.on(ecConfig.EVENT.DATA_ZOOM, eConsole);
        myChart.on(ecConfig.EVENT.LEGEND_SELECTED, eConsole);
        myChart.on(ecConfig.EVENT.MAGIC_TYPE_CHANGED, eConsole);
        myChart.on(ecConfig.EVENT.DATA_VIEW_CHANGED, eConsole);
        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    //------------------------------------------------------------
    }

    // 正态分布与loadChart_chen.js中的drawBarChart_norm相同
    function drawBarChart_norm(result){
        var myChart = echarts.init(document.getElementById('main2'));
        //var bookname=document.getElementById('bookno1')
            // 指定图表的配置项和数据
            var option = {
                title: {
                    //text: bookno = bookname.options[bookname.selectedIndex].text+result.fieldname+'的正态分布'+result.singleheat+','+result.singleheat_value+','+result.normy[result.singleheat_index],
                    text: bookno = result.fieldname_chinese+result.fieldname+'的正态分布',//+result.singleheat+','+result.singleheat_value+','+result.normy[result.singleheat_index],
                    x:'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                        type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                     }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    data: result.normx,
                    axisLabel :{  
                            //interval:0,//横轴信息全部显示
                            //rotate: 60//60度角倾斜显示  
                        } 
                },
                yAxis: {
                    name:'Y'
                },
                series: [{
                    name: '',
                    type: 'bar',
                    data: result.normy,
                    markPoint: {
                        itemStyle : {
                             normal: {
                                 color:'#1e90ff'
                             }
                         },
                        data:[
                                {type : 'max', name: '最大值'},
                                {type : 'min', name: '最小值'},
                                {name : '测试点', value : result.singleheat, xAxis: result.singleheat_value, yAxis: result.normy[result.singleheat_index]},
                                //{name : '测试点1', value : result.singleheat, xAxis: '97840.0000', yAxis: '0.0003'}
                        ]
                    },
                    // markLine: {
                    //     name:'炉次号'+result.fieldname+'的标线'
                    //     itemStyle : {
                    //         normal: {
                    //             color:'#1e90ff'
                    //         }
                    //     },
                    //     data:[
                    //             [
                    //             {name: '标线1起点', value: result.singleheat, xAxis: result.singleheat, yAxis: 0},
                    //             {name: '标线1终点', xAxis: result.singleheat, yAxis: 0.3}
                    //             ]
                    //            ] 
                        
                    // }
                    // itemStyle: {
                    //         normal: {
                    //         //color: 'tomato',
                    //         //barBorderColor: 'tomato',
                    //         barBorderWidth: 6,
                    //         barBorderRadius:0,
                    //         label : {
                    //             show: true, position: 'top'
                    //         }
                    //     }
                    // }

                },
                  {
                    name: '',
                    type: 'line',
                    data: result.normy
                }
                ]

            };

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    }

    //带因素偏高偏低不带钢种的单字段统计
    function ch_num2(fieldname_chinese,fieldname_english){
        var field1 = $("#prime_analyse").val();//炉次号
        //var field2 = $("#field2").val();//字段
        //var field2 = $("#bookno1").find("option:selected").val();
        var field2=fieldname_english;
        var typee=1;
        console.log(field1,field2)
            $.ajax({
            type: "post",
            url:  "/ch_num2",
            data: {'heat':field1,'bookno':field2,'typee':typee},
            error: function() {
                alert("404");
            },
            success: function(data) {
                //alert(data.result);
                //alert(data.result.normx);
                //alert(data.result.normy);
                //alert(data.result['singleheat']);
                //alert(data.result['singleheat_value']);
                //alert(data.result.normx[result.singleheat_index]);
                data.result['fieldname_chinese']=fieldname_chinese;
                alert(data.result['fieldname_chinese']);
                drawBarChart_norm(data.result);
            }
        })

    }; 
    //自动加载钢种
    function loadGrape_chen(){ 
          $.ajax({
         type: "POST",
         dataType:"json",
         url: "/getGrape" ,
         data: {'greet':'hello'},
         success: function(data){
            //alert(data.result);
            //alert(data.result.length);
            pnames=data.result;
            $(".gangzhong_name").append("<option value='blank' selected =\"selected\"></option>");
            for(var pname in pnames){
                console.log(pnames[pname]) 
                $(".gangzhong_name").append("<option value='"+pnames[pname]+"'>"+pnames[pname]+"</option>");
            }
        },
        error: function () {
            alert("error");
            }
         });
        };
        
    //初始化
    $(function(){
            loadOption_chen();
            loadGrape_chen();

        })
</script>
{% endblock %}