{% extends "data_import/base.html" %}
{% block title %}{% if title %}{{ title }}{% endif %}{% endblock %}
{% block pagejs %}
<script type="text/javascript" src="/static/data_import/libs/echarts/echarts.js"></script>
{% endblock pagejs %}
{% block content %}

<h2>波动率相关分析</h2>
<h5><a href='/chen'>返回转炉数据分析</a></h5>
<p><strong>1.请选择要进行波动率计算的各项参数</strong></p>
<form action="javascript:void(0)" method="post">
    <div>
         钢种：<select name="SPECIFICATION" id="SPECIFICATION" class="gangzhong_name"></select>
        班次：<select name="OPERATESHIFT" id="OPERATESHIFT" class="OPERATESHIFT_name">
            <option value='blank' selected = "selected"></option>
            <option value=1>白班</option>
            <option value=2>中班</option>
            <option value=3>夜班</option>
        </select>
        班别：<select name="OPERATECREW" id="OPERATECREW" class="OPERATECREW_name">
            <option value='blank' selected = "selected"></option>
            <option value='A'>甲班</option>
            <option value='B'>乙班</option>
            <option value='C'>丙班</option>
        </select>
        工位：<select name="station" id="station" class="station_name">
            <option value='blank' selected = "selected"></option>
            <option value='BOF1'>BOF1</option>
            <option value='BOF2'>BOF2</option>
            <option value='BOF3'>BOF3</option>
        </select>
        <!-- 字段名：<select name="flu_field" id="flu_field" class="fluctution_time"></select> -->
        <!--<input id="datepicker-example5" type="text">-->
        </div>

        <b>计算波动率的时间范围:</b>
        <div>
        起始时间：<input id="datepicker-example7-start" type="text">
        终止时间：<input id="datepicker-example7-end" type="text">
        </div>
        <b>对比历史波动率的时间范围:</b>
        <div>
        起始时间：<input id="datepicker-example7-start-history" type="text">
        终止时间：<input id="datepicker-example7-end-history" type="text">
        <button onclick='fluc_cost()' id='click1'>成本投入</button>
        <button onclick='fluc_produce()' id='click2'>成本产出</button>
    </div>
    <div style="width:1400px">
        <div id="main1" style="float:left;width:600px;height:450px">左</div>
        <div id="main2" style="float:left;width:600px;height:450px">右</div>
        <!--<textarea id="txt" style="width: 800px;height:100px;">下</textarea></div>-->    
    </div>
    <p></p>
    <div>
        <!--table用来放置因素追溯的分析结果-->
        <table id='txt' style="width: 700px;height:100px;border:0px;">
    <!--         <caption >因素追溯的分析结果</caption>
            <tr> 
            <th>序号</th>
            <th>影响因素中文名</th>
            <th>影响因素英文名</th>
            <th>影响因素回归系数</th>
            <th>影响因素偏离值</th>
            </tr> -->
        </table>
    </div>
</form>

<script type="text/javascript" src="/static/data_import/js/loadChart_chen.js"></script>
<script type="text/javascript" src="/static/data_import/js/loadParam.js"></script>
<script type="text/javascript" src="/static/data_import/js/zebra_datepicker.js"></script>
<link rel="stylesheet" href="/static/data_import/css/default.css" type="text/css">
<script type="text/javascript"> 

	function fluc_cost(){
        var SPECIFICATION = $("#SPECIFICATION").val();//钢种,不用转化为大写
        var OPERATESHIFT = $("#OPERATESHIFT").val();//班次
        var OPERATECREW = $("#OPERATECREW").val();//班别
        var station = $("#station").val();//工位
        var fieldname = $("#flu_field").find("option:selected").val();//字段名
		var time1 = $('#datepicker-example7-start').val();//计算波动率的时间范围起始时间
		var time2 = $('#datepicker-example7-end').val();//计算波动率的时间范围终止时间
        var history_time1 = $('#datepicker-example7-start-history').val();//对比历史波动率的时间范围起始时间
        var history_time2 = $('#datepicker-example7-end-history').val();//对比历史波动率的时间范围终止时间
        var myChart_main1 = echarts.init(document.getElementById('main1'));
        var myChart_main2 = echarts.init(document.getElementById('main2'));
		myChart_main1.showLoading({
                    text: "图表数据正在努力加载..."
                });
        myChart_main2.showLoading({
                    text: "图表数据正在努力加载..."
                });
		//alert(time1);
		//var time1 = new Date(document.getElementById('datepicker-example7-start').value);
		//var time2 = new Date(document.getElementById('datepicker-example7-end').value);
		console.log(time1,time2)
            $.ajax({
            type: "post",
            url:  "/fluc_cost",
            data: {'SPECIFICATION':SPECIFICATION,'OPERATESHIFT':OPERATESHIFT,'OPERATECREW':OPERATECREW,'station':station,'time1':time1,'time2':time2,'fieldname':fieldname,'history_time1':history_time1,'history_time2':history_time2},
            error: function() {
                alert("404");
            },
            success: function(data) {
            	// alert("success!");
                // alert(data.result);
            	//alert(data.result.scope);
            	//alert(data.result.num);
                //alert(data.compare);
                // $("#biaozhuncha").html(">>计算得，在该时间段内，字段"+fieldname+"的标准差（波动率）为："+data.describe.numb[2]); 
                drawBarChart_cost_fluc(data);
                drawBarChart_cost_fluc2(data);
                // myChart_main1.hideLoading();
                // myChart_main2.hideLoading();
            }
        })
    }; 

function fluc_produce(){
        var SPECIFICATION = $("#SPECIFICATION").val();//钢种,不用转化为大写
        var OPERATESHIFT = $("#OPERATESHIFT").val();//班次
        var OPERATECREW = $("#OPERATECREW").val();//班别
        var station = $("#station").val();//工位
        var fieldname = $("#flu_field").find("option:selected").val();//字段名
        var time1 = $('#datepicker-example7-start').val();//计算波动率的时间范围起始时间
        var time2 = $('#datepicker-example7-end').val();//计算波动率的时间范围终止时间
        var history_time1 = $('#datepicker-example7-start-history').val();//对比历史波动率的时间范围起始时间
        var history_time2 = $('#datepicker-example7-end-history').val();//对比历史波动率的时间范围终止时间
        var myChart_main1 = echarts.init(document.getElementById('main1'));
        var myChart_main2 = echarts.init(document.getElementById('main2'));
        myChart_main1.showLoading({
                    text: "图表数据正在努力加载..."
                });
        myChart_main2.showLoading({
                    text: "图表数据正在努力加载..."
                });
        //alert(time1);
        //var time1 = new Date(document.getElementById('datepicker-example7-start').value);
        //var time2 = new Date(document.getElementById('datepicker-example7-end').value);
        console.log(time1,time2)
            $.ajax({
            type: "post",
            url:  "/fluc_produce",
            data: {'SPECIFICATION':SPECIFICATION,'OPERATESHIFT':OPERATESHIFT,'OPERATECREW':OPERATECREW,'station':station,'time1':time1,'time2':time2,'fieldname':fieldname,'history_time1':history_time1,'history_time2':history_time2},
            error: function() {
                alert("404");
            },
            success: function(data) {
                // alert("success!");
                // alert(data.result);
                //alert(data.result.scope);
                //alert(data.result.num);
                //alert(data.compare);

                // drawBarChart_cost_fluc(data);
                drawBarChart_cost_fluc2(data);
                // myChart_main1.hideLoading();
                // myChart_main2.hideLoading();
            }
        })
    }; 


    //初始化时间控件
    $(document).ready(function() {
        //$('#datepicker-example5').Zebra_DatePicker({
            //direction: ['2012-08-01', '2012-08-12']
            //});
            //计算波动率的时间范围
            $('#datepicker-example7-start').Zebra_DatePicker({
                direction: ['2016-01-01', '2016-07-12'],
                pair: $('#datepicker-example7-end')
            });
            $('#datepicker-example7-end').Zebra_DatePicker({
                direction: 1
            });
            //对比历史波动率的时间范围
            $('#datepicker-example7-start-history').Zebra_DatePicker({
                direction: ['2016-01-01', '2016-07-12'],
                pair: $('#datepicker-example7-end-history')
            });
            $('#datepicker-example7-end-history').Zebra_DatePicker({
                direction: 1
            });
        });


    //自动加载钢种
    function loadGrape_chen(){ 
        $.ajax({
        type: "POST",
        dataType:"json",
        url: "/getGrape" ,
        data: {'greet':'hello'},
        success: function(data){
            //alert(data.result);
            //alert(data.result.length);
            pnames=data.result;
            $(".gangzhong_name").append("<option value='blank' selected =\"selected\"></option>");
            for(var pname in pnames){
                console.log(pnames[pname]) 
                $(".gangzhong_name").append("<option value='"+pnames[pname]+"'>"+pnames[pname]+"</option>");
            }
        },
        error: function () {
            alert("error");
            }
         });
        };

            // 条形图（投入）与loadChart_chen.js中的drawBarChart相同(多Y轴)
    function drawBarChart_cost_fluc(result){
        var myChart = echarts.init(document.getElementById('main1'));
        
        var colors = ['#5793f3', '#d14a61', '#675bba','#00c957'];
        var barCategoryGap_value='5%';
            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '在'+result.time1+'至'+result.time2+'时间范围内的成本投入字段波动率计算',
                    x:'center'
                },
                tooltip: {
                    // trigger: 'axis',
                    // axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    //     type : 'shadow',        // 默认为直线，可选为：'line' | 'shadow'
                        trigger:'item',
                        formatter: function (params){
                            var res = params.seriesNames;
                            // var res = result.fieldname_ch[params.seriesIndex]+':</br>波动率实际值：'+params.value+'</br>波动率历史值：'+result.ana_describe_history[params.seriesIndex].numb[2]+ '<br/>偏离程度：'+result.offset_result[params.seriesIndex]+'</br>定性判断：'+result.qualitative_offset_result[params.seriesIndex];                        
                            return res;
                        }
                     
                },
                toolbox: {
                    show : true,
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['']
                },
                xAxis: [{
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: ['转炉工序成本字段的总体分析']
                },
                ],
                yAxis: [{
                    type: 'value',
                    name: '铁水重量',
                    // min: 0,
                    // max: 105000,
                    position: 'left',
                    offset:0,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '耗氧量',
                    // min: 0,
                    // max: 5000,
                    position: 'left',
                    offset: -150,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[1]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} NM3'
                    // }
                },
                {
                    type: 'value',
                    name: '生铁',
                    // min: 0,
                    // max: 2000,
                    position: 'left',
                    splitLine:{show: false},//去除网格线
                    offset: -300,
                    axisLine: {
                        lineStyle: {
                            color: colors[2]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '废钢总和',
                    // min: 0,
                    // max: 12000,
                    position: 'left',
                    offset: -450,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[3]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                }
                ],
                series: [{
                    name: '铁水重量',
                    type: 'bar',
                    // barWidth : 50,//柱条（K线蜡烛）宽度
                    // barGap: '1%',//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap:barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    yAxisIndex: 0,
                    data: [result.fluc_ratio[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name: '铁水重量',
                    type: 'bar',
                    // barWidth : 50,//柱条（K线蜡烛）宽度
                    // barGap: '1%',//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap:barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    yAxisIndex: 0,
                    data: [result.fluc_ratio_history[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'耗氧量',
                    type:'bar',
                    // barWidth : 50,
                    // barGap: '5%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.fluc_ratio[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'耗氧量',
                    type:'bar',
                    // barWidth : 50,
                    // barGap: '5%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.fluc_ratio_history[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'生铁',
                    type:'bar',
                    // barWidth : 50,
                    // barGap: '10%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.fluc_ratio[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                 {
                    name:'生铁',
                    type:'bar',
                    // barWidth : 50,
                    // barGap: '10%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.fluc_ratio_history[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'废钢总和',
                    type:'bar',
                    // barWidth : 70,
                    // barGap: '80%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.fluc_ratio[3]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                 {
                    name:'废钢总和',
                    type:'bar',
                    // barWidth : 70,
                    // barGap: '80%',
                    barCategoryGap:barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.fluc_ratio_history[3]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                }
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.dataIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                // fieldname_chinese=result.fieldname_ch[params.seriesIndex];
                // fieldname_english=result.fieldname_en[params.seriesIndex];
                // probability_distribution(fieldname_chinese,fieldname_english,result.offset_result[params.seriesIndex],params.value);

                // offset_value=result.std_dev[params.dataIndex];//读取偏离值
                // fieldname_english=result.fieldname_en[params.dataIndex];//读取字段英文名字
                // retrospectfactor(fieldname_english,offset_value);
        

            }
            console.log(params);
            });

            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。

    };

function drawBarChart_cost_fluc2(result){
        var myChart = echarts.init(document.getElementById('main2'));
        var colors = ['#5793f3', '#d14a61', '#675bba','#00c957'];
            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '在'+result.time1+'至'+result.time2+'时间范围内的成本投入字段波动率计算',
                    x:'center'
                },
                tooltip: {
                        trigger:'item',
                        formatter: function (params){
                            var res = result.fieldname_ch[params.dataIndex]+'<br/>'+params.seriesName+'：'+params.value+ '<br/>偏离程度：'+result.offset_result[params.dataIndex]+'</br>定性判断：'+result.qualitative_offset_result[params.dataIndex];        
                            // var res = result.fieldname_ch[params.seriesIndex]+':</br>波动率实际值：'+params.value+'</br>波动率历史值：'+result.ana_describe_history[params.seriesIndex].numb[2]+ '<br/>偏离程度：'+result.offset_result[params.seriesIndex]+'</br>定性判断：'+result.qualitative_offset_result[params.seriesIndex];                         
                            return res;
                            }
                     
                },
                toolbox: {
                    show : true,
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['波动率','对比历史波动率']
                },
                xAxis: [{
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: result.fieldname_ch
                },
                ],
                yAxis: [{
                    name:'波动率',
                    type: 'value',
                    // min: 0,
                    // max: 105000,
                    position: 'left',
                    offset:0,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
               
                ],
                series: [{
                    name:'波动率',
                    type: 'bar',
                    // barWidth : 50,//柱条（K线蜡烛）宽度
                    // barGap: '1%',//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap:'10%',//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    yAxisIndex: 0,
                    data: result.fluc_ratio,
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'对比历史波动率',
                    type: 'bar',
                    // barWidth : 50,//柱条（K线蜡烛）宽度
                    // barGap: '1%',//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap:'10%',//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    yAxisIndex: 0,
                    data: result.fluc_ratio_history,
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                // fieldname_chinese=result.fieldname_ch[params.seriesIndex];
                // fieldname_english=result.fieldname_en[params.seriesIndex];
                // probability_distribution(fieldname_chinese,fieldname_english,result.offset_result[params.seriesIndex],params.value);
                offset_value=result.fluc_ratio[params.dataIndex];//读取偏离值
                fieldname_en=result.fieldname_en[params.dataIndex];//读取字段英文名字
                retrospectfactor(fieldname_en,offset_value,result.sentence_select,result.sentence_selecthistory);
            }
            console.log(params);
            });

            //动态循环
            // var barGaps = ['30%', '-100%'];
            // var loopIndex = 0;

            // setInterval(function () {
            //     var barGap = barGaps[loopIndex];

            //     myChart.setOption({
            //         xAxis: {
            //             axisLabel: {
            //                 formatter: 'barGap: \'' + barGap + '\''
            //             }
            //         },
            //         series: [{
            //             barGap: barGap
            //         }]
            //     });
            //     loopIndex = (loopIndex + 1) % barGaps.length;

            // }, 2000);



            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。
    };


       //回归系数因素追溯及其偏离程度
    function retrospectfactor(field,offset_value,sentence_select,sentence_selecthistory){
        // var prime_analyse = $("#prime_analyse").val();
        // console.log(prime_analyse)
        // var offset_value = $("#offset").val();//以铁水重量为例，读取炉次字段的偏离值，传递给后台用来定性判断其偏离程度
        // field='MIRON_WGT';
        // var offset_value = $("#offset1").val();//读取炉次字段的偏离值，传递给后台用来定性判断其偏离程度
        // field='TOTAL_SLAB_WGT';
        var txt = echarts.init(document.getElementById('txt'));
        txt.showLoading({
                    text: "追溯结果正在努力计算中..."
                });
        $.ajax({
            type: "post",
            url:  "/fluc_influence",
            data: {'field':field,'offset_value':offset_value,'sentence_select':sentence_select,'sentence_selecthistory':sentence_selecthistory},
            error: function() {
                alert("成本投入字段需要往前追溯，目前可能会是错误！！");
            },
            success: function(data) {
                //alert(data.result)
                // alert("success");
                // alert(data.offset_number);//字段个数
                // alert(data.xasis_fieldname);//字段英文名数组
                // alert(data.offset_result);//字段偏离程度
                // alert(data.En_to_Ch_result);//字段中文名
                // alert(data.regression_coefficient);
                $("#txt").empty();//清除表格内容
                var content='';
                $("#txt").append("<caption >"+field+"字段因素追溯的分析结果</caption><tr> <th>序号</th><th>影响因素中文名</th><th>影响因素英文名</th><th>影响因素回归系数</th><th>影响因素偏离值</th></tr>");
                for (var i=0;i<data.offset_number;i++){
                    content=content+(i+1)+" : "+data.En_to_Ch_result[i]+"; "+data.xasis_fieldname[i]+"; "+data.regression_coefficient[i]+"; "+data.offset_result[i]+"\n";
                    $("#txt").append(" <tr> <th>"+(i+1)+"</th><th>"+data.En_to_Ch_result[i]+"</th><th>"+data.xasis_fieldname[i]+"</th><th>"+data.regression_coefficient[i]+"</th><th>"+data.offset_result[i]+"</th></tr>")

                }
                // alert(content);
                   
                
            }
        })
    };

 


    //初始化
    $(function(){
            loadOption_chen();
            loadGrape_chen();
        })
</script>




{% endblock %}